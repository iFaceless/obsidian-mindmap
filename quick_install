#!/bin/bash

# ObMind æ’ä»¶å¿«é€Ÿå®‰è£…è„šæœ¬
# ä½¿ç”¨æ–¹æ³•: ./quick_install [obsidian_plugins_directory]

set -e

# é¢œè‰²å®šä¹‰
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# æ‰“å°å¸¦é¢œè‰²çš„æ¶ˆæ¯
print_info() {
    echo -e "${BLUE}[INFO]${NC} $1"
}

print_success() {
    echo -e "${GREEN}[SUCCESS]${NC} $1"
}

print_warning() {
    echo -e "${YELLOW}[WARNING]${NC} $1"
}

print_error() {
    echo -e "${RED}[ERROR]${NC} $1"
}

# æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
show_help() {
    echo "ObMind æ’ä»¶å¿«é€Ÿå®‰è£…è„šæœ¬"
    echo ""
    echo "ä½¿ç”¨æ–¹æ³•:"
    echo "  $0 <plugins_directory>"
    echo ""
    echo "å‚æ•°:"
    echo "  plugins_directory    Obsidian æ’ä»¶ç›®å½•è·¯å¾„ (å¿…éœ€)"
    echo ""
    echo "ç¤ºä¾‹:"
    echo "  $0 ~/Library/Application\\ Support/obsidian/plugins"
    echo "  $0 /path/to/your/obsidian/plugins"
    echo "  $0 ~/.config/obsidian/plugins"
}

# æ£€æŸ¥å¿…è¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
check_required_files() {
    local required_files=("main.js" "manifest.json")

    # æ£€æŸ¥æ˜¯å¦å¯ä»¥è‡ªåŠ¨æ„å»º
    if [[ -f "package.json" ]] && [[ -d "node_modules" ]]; then
        print_info "æ„å»ºæ’ä»¶ä¸­..."
        if npm run build; then
            print_success "æ„å»ºå®Œæˆï¼"
        else
            print_error "æ„å»ºå¤±è´¥ï¼Œè¯·æ‰‹åŠ¨è¿è¡Œ 'npm run build'"
            exit 1
        fi
    else
        print_error "æ— æ³•æ„å»ºï¼Œè¯·å…ˆè¿è¡Œ 'npm install'"
        exit 1
    fi

    for file in "${required_files[@]}"; do
        if [[ ! -f "$file" ]]; then
            print_error "ç¼ºå°‘å¿…è¦æ–‡ä»¶: $fileï¼Œæ„å»ºåä»æœªç”Ÿæˆ"
            exit 1
        fi
    done
}

# æ£€æµ‹æ“ä½œç³»ç»Ÿ
detect_os() {
    case "$(uname -s)" in
        Darwin*)    echo "macos" ;;
        Linux*)     echo "linux" ;;
        CYGWIN*|MINGW*|MSYS*) echo "windows" ;;
        *)          echo "unknown" ;;
    esac
}

# è·å–é»˜è®¤æ’ä»¶ç›®å½•
get_default_plugins_dir() {
    local os=$(detect_os)
    
    case $os in
        "macos")
            echo "$HOME/Library/Application Support/obsidian/plugins"
            ;;
        "linux")
            echo "$HOME/.config/obsidian/plugins"
            ;;
        "windows")
            echo "$APPDATA/Obsidian/plugins"
            ;;
        *)
            echo ""
            ;;
    esac
}

# éªŒè¯æ’ä»¶ç›®å½•
validate_plugins_dir() {
    local dir="$1"
    
    if [[ -z "$dir" ]]; then
        return 1
    fi
    
    # åˆ›å»ºç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
    if [[ ! -d "$dir" ]]; then
        print_warning "æ’ä»¶ç›®å½•ä¸å­˜åœ¨: $dir"
        read -p "æ˜¯å¦åˆ›å»ºæ­¤ç›®å½•? (y/N): " -n 1 -r
        echo
        if [[ $REPLY =~ ^[Yy]$ ]]; then
            mkdir -p "$dir"
            print_success "å·²åˆ›å»ºç›®å½•: $dir"
        else
            return 1
        fi
    fi
    
    return 0
}

# æ‹·è´æ’ä»¶æ–‡ä»¶
copy_plugin_files() {
    local target_dir="$1"
    local plugin_dir="$target_dir/obsidian-mindmap"
    
    # æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨åŒåæ’ä»¶
    if [[ -d "$plugin_dir" ]]; then
        print_warning "æ’ä»¶å·²å­˜åœ¨: $plugin_dir"
        read -p "æ˜¯å¦è¦†ç›–ç°æœ‰æ’ä»¶? (y/N): " -n 1 -r
        echo
        if [[ ! $REPLY =~ ^[Yy]$ ]]; then
            print_info "å®‰è£…å·²å–æ¶ˆ"
            exit 0
        fi
        
        # ç›´æ¥åˆ é™¤ç°æœ‰æ’ä»¶
        print_info "åˆ é™¤ç°æœ‰æ’ä»¶ç›®å½•..."
        rm -rf "$plugin_dir"
    fi
    
    # åˆ›å»ºæ’ä»¶ç›®å½•
    mkdir -p "$plugin_dir"
    
    # æ‹·è´å¿…è¦æ–‡ä»¶
    print_info "æ‹·è´æ’ä»¶æ–‡ä»¶..."
    local files_to_copy=("main.js" "manifest.json")
    
    for file in "${files_to_copy[@]}"; do
        if [[ -f "$file" ]]; then
            cp "$file" "$plugin_dir/"
            print_success "å·²æ‹·è´: $file"
        else
            print_warning "æ–‡ä»¶ä¸å­˜åœ¨ï¼Œè·³è¿‡: $file"
        fi
    done
    
    # æ‹·è´å¯é€‰çš„æ ·å¼æ–‡ä»¶
    if [[ -f "styles.css" ]]; then
        cp "styles.css" "$plugin_dir/"
        print_success "å·²æ‹·è´: styles.css"
    fi
    
    # æ‹·è´ç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if [[ -f "versions.json" ]]; then
        cp "versions.json" "$plugin_dir/"
        print_success "å·²æ‹·è´: versions.json"
    fi
    
    print_success "æ’ä»¶å®‰è£…å®Œæˆ!"
}

# æ˜¾ç¤ºå®‰è£…åè¯´æ˜
show_post_install_info() {
    echo ""
    print_info "å®‰è£…åè¯´æ˜:"
    echo "1. æ‰“å¼€ Obsidian åº”ç”¨"
    echo "2. è¿›å…¥ è®¾ç½® > ç¬¬ä¸‰æ–¹æ’ä»¶"
    echo "3. ç¡®ä¿ 'å®‰å…¨æ¨¡å¼' å·²å…³é—­"
    echo "4. åœ¨ç¤¾åŒºæ’ä»¶åˆ—è¡¨ä¸­æ‰¾åˆ° 'ObMind' å¹¶å¯ç”¨"
    echo "5. æˆ–è€…ç›´æ¥åœ¨å·²å®‰è£…æ’ä»¶ä¸­å¯ç”¨ 'ObMind'"
    echo ""
    print_info "æ’ä»¶åŠŸèƒ½:"
    echo "- å°† Markdown åˆ—è¡¨æ¸²æŸ“ä¸ºäº¤äº’å¼è„‘å›¾"
    echo "- æ”¯æŒç‚¹å‡»èŠ‚ç‚¹å±•å¼€/æŠ˜å å­èŠ‚ç‚¹"
    echo "- è‡ªåŠ¨å¸ƒå±€å’Œå±…ä¸­æ˜¾ç¤º"
    echo ""
    print_info "ä½¿ç”¨æ–¹æ³•:"
    echo "- åœ¨ç¬”è®°ä¸­åˆ›å»ºä»£ç å—ï¼Œä½¿ç”¨ 'obmind' ä½œä¸ºè¯­è¨€æ ‡è¯†ç¬¦"
    echo "- ç¤ºä¾‹:"
    echo '  ```obmind'
    echo '  - æ ¹èŠ‚ç‚¹'
    echo '    - å­èŠ‚ç‚¹ 1'
    echo '    - å­èŠ‚ç‚¹ 2'
    echo '  ```'
    echo "- åˆ‡æ¢åˆ°é¢„è§ˆæ¨¡å¼å³å¯æŸ¥çœ‹è„‘å›¾"
    echo ""
    print_success "ç¥æ‚¨ä½¿ç”¨æ„‰å¿«! ğŸ‰"
}

# ä¸»å‡½æ•°
main() {
    echo "======================================"
    echo "  ObMind å®‰è£…è„šæœ¬"
    echo "======================================"
    echo ""
    
    # æ£€æŸ¥æ˜¯å¦åœ¨æ’ä»¶æ ¹ç›®å½•
    if [[ ! -f "package.json" ]] || [[ ! -d "src" ]]; then
        print_error "è¯·åœ¨æ’ä»¶æ ¹ç›®å½•ä¸­è¿è¡Œæ­¤è„šæœ¬"
        exit 1
    fi
    
    # æ£€æŸ¥å¿…è¦æ–‡ä»¶
    check_required_files
    
    # è·å–æ’ä»¶ç›®å½•
    local plugins_dir="$1"
    if [[ -z "$plugins_dir" ]]; then
        print_error "è¯·æŒ‡å®š Obsidian æ’ä»¶ç›®å½•è·¯å¾„"
        echo ""
        print_info "ä½¿ç”¨æ–¹æ³•: $0 <plugins_directory>"
        echo ""
        print_info "å¸¸è§æ’ä»¶ç›®å½•ä½ç½®:"
        echo "  macOS: ~/Library/Application Support/obsidian/plugins"
        echo "  Linux: ~/.config/obsidian/plugins"
        echo "  Windows: %APPDATA%\\Obsidian\\plugins"
        echo ""
        show_help
        exit 1
    fi
    
    # å±•å¼€ç”¨æˆ·ç›®å½•
    plugins_dir="${plugins_dir/#\~/$HOME}"
    
    # éªŒè¯æ’ä»¶ç›®å½•
    if ! validate_plugins_dir "$plugins_dir"; then
        print_error "æ— æ•ˆçš„æ’ä»¶ç›®å½•: $plugins_dir"
        echo ""
        print_info "å¸¸è§æ’ä»¶ç›®å½•ä½ç½®:"
        echo "  macOS: ~/Library/Application Support/obsidian/plugins"
        echo "  Linux: ~/.config/obsidian/plugins"
        echo "  Windows: %APPDATA%\\Obsidian\\plugins"
        echo ""
        show_help
        exit 1
    fi
    
    # æ‹·è´æ–‡ä»¶
    copy_plugin_files "$plugins_dir"
    
    # æ˜¾ç¤ºå®‰è£…åè¯´æ˜
    show_post_install_info
}

# å¤„ç†å‘½ä»¤è¡Œå‚æ•°
if [[ "$1" == "-h" ]] || [[ "$1" == "--help" ]]; then
    show_help
    exit 0
fi

# è¿è¡Œä¸»å‡½æ•°
main "$@"